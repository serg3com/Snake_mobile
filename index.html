<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Snake Mobile</title>
<style>
  :root{
    --bg:#000;
    --panel: rgba(0,0,0,.72);
    --line: rgba(255,255,255,.12);
    --btn:#1f1f1f;
    --btn2:#2b2b2b;
    --txt:#fff;
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--txt);
    font-family: Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .topbar{
    width:min(92vw, 900px);
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-top:10px;
    margin-bottom:8px;
  }
  #score{
    font-size:26px;
    opacity:.9;
  }
  .menuBtn{
    border:none;
    background:var(--btn);
    color:var(--txt);
    padding:10px 14px;
    border-radius:12px;
    font-size:16px;
    cursor:pointer;
  }
  .menuBtn:active{ background:var(--btn2); }

  canvas{
    background:#111;
    touch-action:none;
    border:1px solid var(--line);
    image-rendering: pixelated;
  }

  .controls{
    margin: 16px 0 18px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .row{ display:flex; justify-content:center; }
  .ctrlBtn{
    width:65px; height:65px;
    font-size:26px;
    margin:6px;
    border-radius:12px;
    border:none;
    background:var(--btn);
    color:var(--txt);
  }
  .ctrlBtn:active{ background:var(--btn2); }

  /* Overlay */
  .overlay{
    position: fixed;
    inset: 0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(3px);
    z-index: 999;
    padding: 16px;
  }
  .overlay.show{ display:flex; }
  .card{
    width:min(92vw, 520px);
    background: var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    padding:18px 16px;
    text-align:center;
  }
  .title{
    font-size:44px;
    margin:6px 0 6px;
  }
  .sub{
    opacity:.85;
    margin: 0 0 14px;
    font-size:18px;
    line-height:1.3;
  }
  .cardBtns{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
  }
  .bigBtn{
    border:none;
    background: var(--btn);
    color:var(--txt);
    padding:12px 16px;
    border-radius:14px;
    font-size:18px;
    cursor:pointer;
    min-width: 140px;
  }
  .bigBtn:active{ background: var(--btn2); }

  .hint{
    margin-top:12px;
    font-size:14px;
    opacity:.75;
  }
</style>
</head>
<body>

<div class="topbar">
  <button class="menuBtn" id="menuBtn">☰ Menu</button>
  <div id="score">Score: 0</div>
  <div style="width:86px;"></div> <!-- чтобы score был по центру -->
</div>

<canvas id="game"></canvas>

<div class="controls">
  <div class="row">
    <button class="ctrlBtn" onclick="setDirection('up')">⬆️</button>
  </div>
  <div class="row">
    <button class="ctrlBtn" onclick="setDirection('left')">⬅️</button>
    <button class="ctrlBtn" onclick="setDirection('down')">⬇️</button>
    <button class="ctrlBtn" onclick="setDirection('right')">➡️</button>
  </div>
</div>

<!-- Overlay (Menu / Game Over) -->
<div class="overlay" id="overlay">
  <div class="card">
    <div class="title" id="overlayTitle">MENU</div>
    <div class="sub" id="overlaySub">Paused</div>
    <div class="cardBtns">
      <button class="bigBtn" id="btnResume">Resume</button>
      <button class="bigBtn" id="btnRestart">Restart</button>
    </div>
    <div class="hint">Tip: можно управлять свайпами по полю</div>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const scoreEl = document.getElementById("score");
const overlay = document.getElementById("overlay");
const overlayTitle = document.getElementById("overlayTitle");
const overlaySub = document.getElementById("overlaySub");
const btnResume = document.getElementById("btnResume");
const btnRestart = document.getElementById("btnRestart");
const menuBtn = document.getElementById("menuBtn");

let size = 20;               // размер клетки
let tilesX = 0, tilesY = 0;

let snake, direction, food, score, speed, gameRunning;
let timerId = null;          // setTimeout id
let state = "play";          // play | pause | over

function resizeCanvas(){
  // квадратное поле почти на весь экран
  const maxSide = Math.min(window.innerWidth - 20, window.innerHeight - 220);
  const side = Math.max(260, maxSide);
  const fitted = Math.floor(side / size) * size;

  canvas.width = fitted;
  canvas.height = fitted;

  tilesX = canvas.width / size;
  tilesY = canvas.height / size;
}

window.addEventListener("resize", () => {
  resizeCanvas();
  restartGame(false);
});

function initState(){
  const startX = Math.floor(tilesX / 2);
  const startY = Math.floor(tilesY / 2);

  snake = [
    {x: startX, y: startY},
    {x: startX, y: startY + 1},
    {x: startX, y: startY + 2}
  ];

  direction = "up";
  score = 0;
  speed = 120;
  gameRunning = true;
  state = "play";

  food = randomFood();
  scoreEl.textContent = "Score: 0";
}

function randomFood(){
  while(true){
    const f = {
      x: Math.floor(Math.random() * tilesX),
      y: Math.floor(Math.random() * tilesY)
    };
    if(!snake.some(p => p.x === f.x && p.y === f.y)) return f;
  }
}

function setDirection(newDir){
  if(state !== "play") return;

  if (newDir === "left" && direction !== "right") direction = "left";
  if (newDir === "right" && direction !== "left") direction = "right";
  if (newDir === "up" && direction !== "down") direction = "up";
  if (newDir === "down" && direction !== "up") direction = "down";
}

function update(){
  const head = {...snake[0]};

  if(direction === "up") head.y--;
  if(direction === "down") head.y++;
  if(direction === "left") head.x--;
  if(direction === "right") head.x++;

  // стены
  if(head.x < 0 || head.y < 0 || head.x >= tilesX || head.y >= tilesY){
    showGameOver();
    return;
  }

  // в себя
  if(snake.some(p => p.x === head.x && p.y === head.y)){
    showGameOver();
    return;
  }

  snake.unshift(head);

  if(head.x === food.x && head.y === food.y){
    score++;
    scoreEl.textContent = "Score: " + score;
    food = randomFood();
    // хочешь ускорение? раскомментируй:
    // speed = Math.max(55, 120 - score * 2);
  } else {
    snake.pop();
  }
}

function draw(){
  ctx.fillStyle = "black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // рамка
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.strokeRect(0,0,canvas.width,canvas.height);

  // еда
  ctx.fillStyle = "red";
  ctx.fillRect(food.x * size, food.y * size, size, size);

  // змейка
  ctx.fillStyle = "lime";
  for(const p of snake){
    ctx.fillRect(p.x * size, p.y * size, size, size);
  }
}

function loop(){
  if(!gameRunning || state !== "play") return;

  update();
  draw();

  timerId = setTimeout(loop, speed);
}

function stopLoop(){
  if(timerId !== null){
    clearTimeout(timerId);
    timerId = null;
  }
}

function restartGame(startLoop=true){
  stopLoop();
  initState();
  draw();
  hideOverlay();
  if(startLoop) loop();
}

function showOverlay(title, sub, showResume){
  overlayTitle.textContent = title;
  overlaySub.textContent = sub;
  btnResume.style.display = showResume ? "" : "none";
  overlay.classList.add("show");
}

function hideOverlay(){
  overlay.classList.remove("show");
}

function pauseGame(){
  if(state !== "play") return;
  state = "pause";
  stopLoop();
  showOverlay("MENU", "Paused", true);
}

function resumeGame(){
  if(state !== "pause") return;
  state = "play";
  hideOverlay();
  loop();
}

function showGameOver(){
  state = "over";
  gameRunning = false;
  stopLoop();
  draw(); // дорисуем последнее состояние
  showOverlay("GAME OVER", `Score: ${score}`, false);
}

// --- UI кнопки ---
menuBtn.addEventListener("click", () => {
  if(state === "play") pauseGame();
  else if(state === "pause") resumeGame();
  else if(state === "over") restartGame(true);
});

btnResume.addEventListener("click", resumeGame);
btnRestart.addEventListener("click", () => restartGame(true));

// --- Свайпы по canvas ---
let startX = 0, startY = 0;

canvas.addEventListener("touchstart", (e) => {
  if(state !== "play") return;
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
}, {passive:true});

canvas.addEventListener("touchmove", (e) => {
  if(state !== "play") return;

  const dx = e.touches[0].clientX - startX;
  const dy = e.touches[0].clientY - startY;

  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 30) setDirection("right");
    if(dx < -30) setDirection("left");
  } else {
    if(dy > 30) setDirection("down");
    if(dy < -30) setDirection("up");
  }
}, {passive:true});

// --- Старт ---
resizeCanvas();
restartGame(true);
</script>

</body>
</html>
